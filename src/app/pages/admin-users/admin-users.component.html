<div class="container py-4">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h2 class="h4 mb-0">Usuarios</h2>
    <button class="btn btn-outline-secondary btn-sm" (click)="load()" [disabled]="loading()">Actualizar</button>
  </div>

  <div class="card shadow-sm">
    <div class="card-body border-bottom">
      <div class="row g-2 align-items-center">
        <div class="col-12 col-md-5">
          <div class="input-group">
            <span class="input-group-text">Buscar</span>
<input
  class="form-control"
  type="search"
  placeholder="nombre, email, DNI, obra social, rol…"
  [value]="q()"
  (input)="q.set(($any($event.target)).value)"
/>
          </div>
        </div>
        <div class="col-6 col-md-3">
<select
  class="form-select"
  [value]="role()"
  (change)="role.set(($any($event.target)).value)"
>
  <option value="all">Todos los roles</option>
  <option value="admin">Admin</option>
  <option value="especialista">Especialista</option>
  <option value="paciente">Paciente</option>
</select>
        </div>
        <div class="col-6 col-md-3 form-check ps-5">
<input
  id="onlyPending"
  class="form-check-input"
  type="checkbox"
  [checked]="onlyPending()"
  (change)="onlyPending.set(($any($event.target)).checked)"
/>
<label for="onlyPending" class="form-check-label">Solo pendientes de aprobación</label>
        </div>
      </div>
    </div>

    <!-- Tabla -->
    <div class="table-responsive position-relative">
      <!-- Spinner overlay -->
      <div class="loading-overlay" *ngIf="loading()">
        <div class="spinner-border" role="status" aria-label="Cargando"></div>
      </div>

      <table class="table table-hover align-middle mb-0">
        <thead class="table-light table-sticky">
        <tr>
          <th>Nombre</th>
          <th>Role</th>
          <th>Email</th>
          <th>DNI</th>
          <th>Obra Social</th>
          <th>Aprobado</th>
          <th class="text-end">Acciones</th>
        </tr>
        </thead>
        <tbody *ngIf="!loading() && filtered().length; else emptyState">
          <tr *ngFor="let r of filtered()">
            <td class="fw-medium">
              {{ nameOf(r) }}
              <div class="text-muted small" *ngIf="!r.nombre && !r.apellido">Sin nombre</div>
            </td>
            <td>
              <span class="badge" [class.bg-dark]="r.role==='admin'"
                                  [class.bg-primary]="r.role==='especialista'"
                                  [class.bg-secondary]="r.role==='paciente'">
                {{ r.role }}
              </span>
            </td>
            <td><a *ngIf="r.email" [href]="'mailto:'+r.email">{{ r.email }}</a><span *ngIf="!r.email">—</span></td>
            <td>{{ r.dni || '—' }}</td>
            <td>{{ r.obra_social || '—' }}</td>
            <td>
              <span class="badge" [class.bg-success]="r.is_approved" [class.bg-warning]="!r.is_approved">
                {{ r.is_approved ? 'Sí' : 'Pendiente' }}
              </span>
            </td>
            <td class="text-end">
              <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-success" (click)="toggleApprove(r)">
                  {{ r.is_approved ? 'Desaprobar' : 'Aprobar' }}
                </button>
                <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                  Rol
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li><button class="dropdown-item" (click)="setRole(r,'admin')">Admin</button></li>
                  <li><button class="dropdown-item" (click)="setRole(r,'especialista')">Especialista</button></li>
                  <li><button class="dropdown-item" (click)="setRole(r,'paciente')">Paciente</button></li>
                </ul>
              </div>
            </td>
          </tr>
        </tbody>
      </table>

      <ng-template #emptyState>
        <div class="p-4 text-center text-muted">
          <div class="mb-2">No hay usuarios que coincidan con el filtro.</div>
          <div class="small">Cambiá la búsqueda o los filtros para ver resultados.</div>
        </div>
      </ng-template>
    </div>
  </div>
</div>
