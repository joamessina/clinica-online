<div class="admin-users-page container-fluid px-4 py-4">
  <div class="row justify-content-center">
    <div class="col-12">
      <!-- HEADER / ACCIONES -->
      <div
        class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3 gap-2 page-title-bar"
      >
        <div class="page-header-pill">
          <h1 class="h4 mb-1">Gestión de usuarios</h1>
          <p class="text-muted small mb-0">
            Perfil administrador · aprobaciones, roles y exportación a Excel.
          </p>
        </div>

        <div class="btn-toolbar gap-2 flex-wrap admin-actions">
          <button
            type="button"
            class="btn btn-outline-primary d-flex align-items-center gap-1"
            [routerLink]="['/admin/turnos']"
          >
            <i class="bi bi-calendar-event"></i>
            <span>Ver turnos</span>
          </button>

          <button
            type="button"
            class="btn btn-outline-secondary d-flex align-items-center gap-1"
            [routerLink]="['/admin/reportes']"
          >
            <i class="bi bi-bar-chart"></i>
            <span>Reportes</span>
          </button>

          <div class="btn-group">
            <button
              class="btn btn-primary btn-sm d-flex align-items-center gap-1"
              (click)="openCreate()"
            >
              <i class="bi bi-person-plus"></i>
              <span>Nuevo usuario</span>
            </button>
            <button
              class="btn btn-outline-secondary btn-sm"
              (click)="load()"
              [disabled]="loading()"
            >
              <span
                class="spinner-border spinner-border-sm me-1"
                *ngIf="loading()"
              ></span>
              Actualizar
            </button>
            <button
              type="button"
              class="btn btn-success btn-sm d-flex align-items-center gap-1"
              (click)="exportExcel()"
            >
              <i class="bi bi-file-earmark-excel"></i>
              <span>Excel</span>
            </button>
          </div>
        </div>
      </div>

      <!-- FILTROS -->
      <div class="card shadow-sm mb-3 filters-card" appHoverElevate>
        <div class="card-body py-3">
          <div class="row g-2 align-items-center">
            <div class="col-12 col-lg-6">
              <label class="form-label mb-1 small text-uppercase text-muted">
                Búsqueda global
              </label>
              <div class="input-group">
                <span class="input-group-text">
                  <i class="bi bi-search"></i>
                </span>
                <input
                  class="form-control"
                  type="search"
                  placeholder="Nombre, email, DNI, obra social, rol…"
                  [value]="q()"
                  (input)="q.set($any($event.target).value)"
                />
              </div>
            </div>

            <div class="col-6 col-lg-3">
              <label class="form-label mb-1 small text-uppercase text-muted">
                Rol
              </label>
              <select
                class="form-select"
                [value]="role()"
                (change)="role.set($any($event.target).value)"
              >
                <option value="all">Todos los roles</option>
                <option value="admin">Admin</option>
                <option value="especialista">Especialista</option>
                <option value="paciente">Paciente</option>
              </select>
            </div>

            <div class="col-6 col-lg-3">
              <div
                class="form-check form-switch mt-4 mt-lg-3 d-flex align-items-center gap-2 justify-content-lg-end"
              >
                <input
                  id="onlyPending"
                  class="form-check-input"
                  type="checkbox"
                  [checked]="onlyPending()"
                  (change)="onlyPending.set($any($event.target).checked)"
                />
                <label
                  for="onlyPending"
                  class="form-check-label small text-muted"
                >
                  Solo pendientes de aprobación
                </label>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- CARD DE ACCESO RÁPIDO A EXCEL POR USUARIO -->
      <div
        class="card shadow-sm quick-export-card mb-3"
        *ngIf="filtered().length"
        appHoverElevate
      >
        <div class="card-body py-3">
          <div
            class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-2"
          >
            <div class="d-flex align-items-center gap-2">
              <span class="quick-pill-icon">
                <i class="bi bi-stars"></i>
              </span>
              <div>
                <div class="fw-semibold small text-uppercase text-muted">
                  Descargar turnos por usuario
                </div>
                <div class="small text-muted d-md-none">
                  Tocá un usuario para bajar sus turnos en Excel.
                </div>
              </div>
            </div>

            <div class="small text-muted d-none d-md-block">
              Click en un usuario para bajar en Excel los turnos que tomó y con
              quién.
            </div>
          </div>

          <div class="quick-users-scroll">
            <button
              type="button"
              class="fav-user"
              *ngFor="let u of filtered()"
              (click)="exportUserAppointments(u)"
              [title]="nameOf(u)"
            >
              <div class="fav-avatar-wrapper">
                <img
                  [src]="u.avatar_url || placeholderUrl"
                  class="fav-avatar"
                  (error)="imgFallback($event)"
                  alt="avatar"
                />
                <span class="fav-star">
                  <i class="bi bi-file-earmark-excel-fill"></i>
                </span>
              </div>
              <span class="fav-name">{{ u | fullName }}</span>
            </button>
          </div>
        </div>
      </div>

      <!-- TABLA (CARD PRINCIPAL) -->
      <div class="card shadow-sm users-table-card" appHoverElevate>
        <div class="card-body p-0">
          <div class="table-responsive position-relative">
            <!-- Spinner overlay -->
            <div class="loading-overlay" *ngIf="loading()">
              <div
                class="spinner-border"
                role="status"
                aria-label="Cargando"
              ></div>
            </div>

            <table class="table table-hover align-middle mb-0 users-table">
              <thead class="table-light table-sticky">
                <tr>
                  <th scope="col">Foto</th>
                  <th scope="col">Nombre</th>
                  <th scope="col">Rol</th>
                  <th scope="col">Email</th>
                  <th scope="col">DNI</th>
                  <th scope="col">Obra Social</th>
                  <th scope="col">Especialidad</th>
                  <th scope="col">Aprobado</th>
                  <th scope="col" class="text-end">Acciones</th>
                </tr>
              </thead>
              <tbody *ngIf="!loading() && filtered().length; else emptyState">
                <tr *ngFor="let r of filtered()" class="user-row">
                  <!-- FOTO -->
                  <td class="text-center">
                    <img
                      class="admin-avatar"
                      [@avatarZoom]="hoveredId() === r.id ? 'zoom' : 'normal'"
                      (mouseenter)="hoveredId.set(r.id)"
                      (mouseleave)="hoveredId.set(null)"
                      [src]="r.avatar_url || placeholderUrl"
                      alt="avatar"
                      (error)="imgFallback($event)"
                    />
                  </td>

                  <!-- NOMBRE -->
                  <td class="fw-medium">
                    <div>{{ r | fullName }}</div>
                    <div
                      class="text-muted small"
                      *ngIf="!r.nombre && !r.apellido"
                    >
                      Sin nombre
                    </div>
                  </td>

                  <!-- ROL -->
                  <td>
                    <span
                      class="badge role-badge"
                      [class.role-admin]="r.role === 'admin'"
                      [class.role-especialista]="r.role === 'especialista'"
                      [class.role-paciente]="r.role === 'paciente'"
                    >
                      {{ r.role | roleLabel }}
                    </span>
                  </td>

                  <!-- EMAIL -->
                  <td>
                    <a *ngIf="r.email" [href]="'mailto:' + r.email">{{
                      r.email
                    }}</a>
                    <span *ngIf="!r.email">—</span>
                  </td>

                  <!-- DNI -->
                  <td>{{ r.dni || "—" }}</td>

                  <!-- OBRA SOCIAL -->
                  <td>{{ r.obra_social || "—" }}</td>

                  <!-- ESPECIALIDAD -->
                  <td>
                    <ng-container *ngIf="r.role === 'especialista'; else guion">
                      <ng-container *ngIf="r.specialties?.length; else noSpecs">
                        <span
                          class="badge rounded-pill text-bg-light me-1 speciality-pill"
                          *ngFor="let s of r.specialties"
                        >
                          {{ s }}
                        </span>
                      </ng-container>
                      <ng-template #noSpecs>—</ng-template>
                    </ng-container>
                    <ng-template #guion>—</ng-template>
                  </td>

                  <!-- APROBADO -->
                  <td>
                    <span
                      class="badge status-badge"
                      [class.status-ok]="r.is_approved"
                      [class.status-pending]="!r.is_approved"
                    >
                      {{ r.is_approved | yesNo : "Sí" : "Pendiente" }}
                    </span>
                  </td>

                  <!-- ACCIONES -->
                  <td class="text-end">
                    <div
                      class="btn-group btn-group-sm"
                      ngbDropdown
                      placement="bottom-end"
                    >
                      <button
                        type="button"
                        class="btn btn-outline-success"
                        (click)="toggleApprove(r)"
                      >
                        {{ r.is_approved ? "Desaprobar" : "Aprobar" }}
                      </button>
                      <button
                        type="button"
                        class="btn btn-outline-secondary dropdown-toggle"
                        data-bs-toggle="dropdown"
                      >
                        Rol
                      </button>
                      <ul class="dropdown-menu dropdown-menu-end">
                        <li>
                          <button
                            class="dropdown-item"
                            (click)="setRole(r, 'admin')"
                          >
                            Admin
                          </button>
                        </li>
                        <li>
                          <button
                            class="dropdown-item"
                            (click)="setRole(r, 'especialista')"
                          >
                            Especialista
                          </button>
                        </li>
                        <li>
                          <button
                            class="dropdown-item"
                            (click)="setRole(r, 'paciente')"
                          >
                            Paciente
                          </button>
                        </li>
                      </ul>
                    </div>

                    <button
                      class="btn btn-sm btn-outline-primary ms-2"
                      *ngIf="r.role === 'paciente'"
                      (click)="openHistory(r)"
                    >
                      Historia
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>

            <ng-template #emptyState>
              <div class="p-4 text-center text-muted">
                <div class="mb-2">
                  No hay usuarios que coincidan con el filtro.
                </div>
                <div class="small">
                  Cambiá la búsqueda o los filtros para ver resultados.
                </div>
              </div>
            </ng-template>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL CREAR USUARIO -->
  <div class="modal fade show d-block" tabindex="-1" *ngIf="showCreate()">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-person-plus me-2"></i>Crear usuario
          </h5>
          <button
            type="button"
            class="btn-close"
            (click)="closeCreate()"
          ></button>
        </div>

        <form (ngSubmit)="createUser()">
          <div class="modal-body">
            <div class="row g-3">
              <!-- Rol -->
              <div class="col-12">
                <label class="form-label fw-semibold">Rol</label>
                <div class="btn-group" role="group">
                  <input
                    type="radio"
                    class="btn-check"
                    id="nu-rol-pac"
                    [value]="'paciente'"
                    [(ngModel)]="newUser().role"
                    name="nu_role"
                  />
                  <label class="btn btn-outline-primary" for="nu-rol-pac"
                    >Paciente</label
                  >

                  <input
                    type="radio"
                    class="btn-check"
                    id="nu-rol-esp"
                    [value]="'especialista'"
                    [(ngModel)]="newUser().role"
                    name="nu_role"
                  />
                  <label class="btn btn-outline-primary" for="nu-rol-esp"
                    >Especialista</label
                  >

                  <input
                    type="radio"
                    class="btn-check"
                    id="nu-rol-adm"
                    [value]="'admin'"
                    [(ngModel)]="newUser().role"
                    name="nu_role"
                  />
                  <label class="btn btn-outline-dark" for="nu-rol-adm"
                    >Admin</label
                  >
                </div>
              </div>

              <!-- Nombre / Apellido -->
              <div class="col-md-6">
                <label class="form-label">Nombre</label>
                <input
                  class="form-control"
                  [class.is-invalid]="submitted() && !newUser().nombre"
                  [(ngModel)]="newUser().nombre"
                  name="nu_nombre"
                />
                <div class="invalid-feedback">Requerido.</div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Apellido</label>
                <input
                  class="form-control"
                  [(ngModel)]="newUser().apellido"
                  name="nu_apellido"
                />
              </div>

              <!-- Edad / DNI -->
              <div class="col-md-4">
                <label class="form-label">Edad</label>
                <input
                  type="number"
                  class="form-control"
                  [(ngModel)]="newUser().edad"
                  name="nu_edad"
                  min="0"
                />
              </div>
              <div class="col-md-4">
                <label class="form-label">DNI</label>
                <input
                  class="form-control"
                  [(ngModel)]="newUser().dni"
                  name="nu_dni"
                />
              </div>

              <!-- Obra social solo paciente -->
              <div class="col-md-4" *ngIf="newUser().role === 'paciente'">
                <label class="form-label">Obra Social</label>
                <input
                  class="form-control"
                  [class.is-invalid]="submitted() && !newUser().obra_social"
                  [(ngModel)]="newUser().obra_social"
                  name="nu_obra"
                />
                <div class="invalid-feedback">Requerida para paciente.</div>
              </div>

              <div class="col-md-6">
                <label class="form-label">Email</label>
                <input
                  type="email"
                  class="form-control"
                  [class.is-invalid]="submitted() && !newUser().email"
                  [(ngModel)]="newUser().email"
                  name="nu_email"
                />
                <div class="invalid-feedback">Requerido.</div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Contraseña</label>
                <input
                  type="password"
                  class="form-control"
                  [class.is-invalid]="submitted() && !newUser().password"
                  [(ngModel)]="newUser().password"
                  name="nu_pass"
                />
                <div class="invalid-feedback">Requerida.</div>
                <div class="form-text">
                  Se enviará email de confirmación si está habilitado.
                </div>
              </div>
            </div>
          </div>

          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-outline-secondary"
              (click)="closeCreate()"
            >
              Cancelar
            </button>
            <button
              type="submit"
              class="btn btn-primary"
              [disabled]="creating()"
            >
              <span
                class="spinner-border spinner-border-sm me-2"
                *ngIf="creating()"
              ></span>
              Crear
            </button>
          </div>
        </form>
      </div>
    </div>

    <div class="modal-backdrop-custom"></div>
  </div>

  <!-- MODAL HISTORIA CLÍNICA (ADMIN) -->
  <div class="modal fade show d-block" tabindex="-1" *ngIf="showHistory()">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            Historia clínica – {{ historyPatientName() }}
          </h5>
          <button
            type="button"
            class="btn-close"
            (click)="closeHistory()"
          ></button>
        </div>

        <div class="modal-body">
          <div *ngIf="historyLoading()" class="text-muted">
            Cargando historia clínica…
          </div>

          <div
            *ngIf="!historyLoading() && !historyRows().length"
            class="text-muted"
          >
            No hay historias clínicas cargadas para este paciente.
          </div>

          <div *ngIf="!historyLoading() && historyRows().length">
            <div
              *ngFor="let h of historyRows()"
              class="border rounded p-3 mb-3 small"
            >
              <div class="fw-semibold mb-1">
                {{ h.fecha | date : "d/MM/yyyy" }} –
                {{ h.hora?.slice(0, 5) }}
              </div>
              <div class="mb-1">
                <strong>Especialista:</strong>
                {{ h.especialista_nombre || "—" }}
              </div>
              <div class="mb-1">
                <strong>Especialidad:</strong>
                {{ h.especialidad_nombre || "—" }}
              </div>

              <div class="mb-1">
                <strong>Altura:</strong> {{ h.altura || "—" }} ·
                <strong>Peso:</strong> {{ h.peso || "—" }}
              </div>
              <div class="mb-1">
                <strong>Temperatura:</strong> {{ h.temperatura || "—" }} ·
                <strong>Presión:</strong> {{ h.presion || "—" }}
              </div>

              <div *ngIf="h.extras?.length">
                <strong>Datos adicionales:</strong>
                <ul class="mb-0">
                  <li *ngFor="let e of h.extras">{{ e.key }}: {{ e.value }}</li>
                </ul>
              </div>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-outline-secondary"
            (click)="closeHistory()"
          >
            Cerrar
          </button>
        </div>
      </div>
    </div>

    <!-- backdrop para HISTORIA -->
    <div class="modal-backdrop-custom"></div>
  </div>
</div>
