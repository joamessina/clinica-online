<!-- Encabezado -->
<div class="d-flex align-items-center justify-content-between mb-3">
  <!-- botón volver a la derecha -->
  <app-back-button variant="outline-secondary" size="sm" label="Volver">
  </app-back-button>
</div>
<div class="container py-4" *ngIf="!loading(); else cargando">
  <h2 class="mb-3">Mi perfil</h2>

  <div class="card shadow-sm">
    <div class="card-body d-flex gap-3 align-items-center">
      <img
        [src]="perfil()?.avatar_url"
        class="rounded-circle"
        width="96"
        height="96"
        alt="Avatar"
      />
      <div>
        <div class="h5 mb-1">
          {{ perfil()?.nombre }} {{ perfil()?.apellido }}
        </div>
        <div class="text-muted">
          <span class="badge bg-secondary me-2 text-uppercase">{{
            perfil()?.role
          }}</span>
          {{ perfil()?.email }}
        </div>
      </div>
    </div>

    <div class="card-body border-top">
      <div class="row g-3">
        <div class="col-md-4">
          <strong>DNI:</strong> {{ perfil()?.dni || "—" }}
        </div>
        <div class="col-md-4">
          <strong>Edad:</strong> {{ perfil()?.edad || "—" }}
        </div>
        <div class="col-md-4" *ngIf="perfil()?.role === 'paciente'">
          <strong>Obra social:</strong> {{ perfil()?.obra_social || "—" }}
        </div>

        <div class="col-12" *ngIf="perfil()?.role === 'especialista'">
          <strong>Especialidades:</strong>
          <ng-container
            *ngIf="(perfil()?.specialties?.length || 0) > 0; else noSpec"
          >
            <span
              class="badge bg-outline border me-2"
              *ngFor="let s of perfil()?.specialties"
            >
              {{ s.nombre }}
            </span>
          </ng-container>
          <ng-template #noSpec>—</ng-template>
        </div>
      </div>

      <div class="mt-3" *ngIf="perfil()?.role === 'especialista'">
        <a
          class="btn btn-outline-primary"
          routerLink="/especialista/mis-horarios"
        >
          <i class="bi bi-clock me-1"></i> Mis horarios
        </a>
      </div>
    </div>
  </div>
</div>

<div class="card mt-3" *ngIf="perfil()?.role === 'paciente'">
  <div class="card-header">
    <i class="bi bi-journal-medical me-1"></i> Historia clínica
  </div>

  <div class="card-body" *ngIf="historial().length; else sinHist">
    <div class="accordion" id="historiaPaciente">
      <div class="accordion-item" *ngFor="let h of historial(); let i = index">
        <h2 class="accordion-header" [id]="'h-head-' + i">
          <button
            class="accordion-button collapsed"
            type="button"
            data-bs-toggle="collapse"
            [attr.data-bs-target]="'#h-body-' + i"
            aria-expanded="false"
          >
            <span class="me-2">
              {{ h.fecha | date : "shortDate" }}
              • {{ h.especialidad_nombre || "Sin especialidad" }}
            </span>
            <span class="text-muted small" *ngIf="h.especialista_nombre">
              ({{ h.especialista_nombre }})
            </span>
          </button>
        </h2>

        <div
          class="accordion-collapse collapse"
          [id]="'h-body-' + i"
          [attr.aria-labelledby]="'h-head-' + i"
          data-bs-parent="#historiaPaciente"
        >
          <div class="accordion-body">
            <div class="row mb-2">
              <div class="col-6 col-md-3">
                <strong>Altura:</strong> {{ h.altura || "—" }} cm
              </div>
              <div class="col-6 col-md-3">
                <strong>Peso:</strong> {{ h.peso || "—" }} kg
              </div>
              <div class="col-6 col-md-3">
                <strong>Temperatura:</strong> {{ h.temperatura || "—" }} °C
              </div>
              <div class="col-6 col-md-3">
                <strong>Presión:</strong> {{ h.presion || "—" }}
              </div>
            </div>

            <div *ngIf="h.extras.length; else sinExtras">
              <strong>Datos adicionales:</strong>
              <ul class="mb-0">
                <li *ngFor="let e of h.extras">
                  <span class="fw-semibold">{{ e.key }}:</span>
                  {{ e.value }}
                </li>
              </ul>
            </div>
            <ng-template #sinExtras>
              <div class="text-muted small">
                Sin datos adicionales en esta atención.
              </div>
            </ng-template>
          </div>
        </div>
      </div>
    </div>
  </div>

  <ng-template #sinHist>
    <p class="text-muted mb-0">Todavía no tenés historia clínica cargada.</p>
  </ng-template>
</div>

<ng-template #cargando>
  <div class="container py-5 text-center text-muted">Cargando perfil…</div>
</ng-template>
