<div class="container py-4">
  <div class="row justify-content-center">
    <div class="col-xl-8 col-lg-9">
      <div class="card shadow-sm">
        <div class="card-header bg-light d-flex align-items-center gap-2">
          <i class="bi bi-person-plus"></i>
          <h5 class="mb-0">
  {{ 'register.title' | t }}
</h5>

        </div>

        <div class="card-body">
          <!-- Selector visual de perfil (solo se ve al entrar) -->
          <div *ngIf="!rol" class="role-picker mb-3">
            <button
              type="button"
              class="role-btn"
              (click)="chooseRole('paciente')"
            >
              <img [src]="patientImgUrl" alt="Paciente" />
<span>{{ 'register.patient' | t }}</span>
            </button>

            <button
              type="button"
              class="role-btn"
              (click)="chooseRole('especialista')"
            >
<img [src]="specialistImgUrl" alt="Especialista" />
<span>{{ 'register.specialist' | t }}</span>
            </button>
          </div>

          <form *ngIf="rol" #f="ngForm" novalidate>
            <!-- Datos personales -->
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">
  {{ 'register.name' | t }}
</label>
                <input
                  class="form-control"
                  name="nombre"
                  [(ngModel)]="nombre"
                  required
                  #nombreNg="ngModel"
                  [class.is-invalid]="
                    nombreNg.invalid && (nombreNg.touched || f.submitted)
                  "
                />
                <div class="invalid-feedback">Nombre obligatorio.</div>
              </div>

              <div class="col-md-6">
                <label class="form-label">
  {{ 'register.lastname' | t }}
</label>
                <input
                  class="form-control"
                  name="apellido"
                  [(ngModel)]="apellido"
                  required
                  #apellidoNg="ngModel"
                  [class.is-invalid]="
                    apellidoNg.invalid && (apellidoNg.touched || f.submitted)
                  "
                />
                <div class="invalid-feedback">Apellido obligatorio.</div>
              </div>

              <div class="col-md-4">
               <label class="form-label">
  {{ 'register.age' | t }}
</label>
                <input
                  type="number"
                  class="form-control"
                  name="edad"
                  [(ngModel)]="edad"
                  min="1"
                  required
                  #edadNg="ngModel"
                  [class.is-invalid]="
                    edadNg.invalid && (edadNg.touched || f.submitted)
                  "
                />
                <div class="invalid-feedback">
                  <ng-container *ngIf="edadNg.errors?.['required']"
                    >Edad obligatoria.</ng-container
                  >
                  <ng-container *ngIf="edadNg.errors?.['min']"
                    >Debe ser mayor a 0.</ng-container
                  >
                </div>
              </div>

              <div class="col-md-4">
                <label class="form-label">
  {{ 'register.dni' | t }}
</label>
                <input
                  class="form-control"
                  name="dni"
                  [(ngModel)]="dni"
                  required
                  #dniNg="ngModel"
                  [class.is-invalid]="
                    dniNg.invalid && (dniNg.touched || f.submitted)
                  "
                />
                <div class="invalid-feedback">DNI obligatorio.</div>
              </div>

              <div class="col-md-4" *ngIf="rol === 'paciente'">
                <label class="form-label" *ngIf="rol === 'paciente'">
  {{ 'register.healthInsurance' | t }}
</label>
                <input
                  class="form-control"
                  name="obra"
                  [(ngModel)]="obra_social"
                  required
                  #obraNg="ngModel"
                  [class.is-invalid]="
                    obraNg.invalid && (obraNg.touched || f.submitted)
                  "
                />
                <div class="invalid-feedback">Obra social obligatoria.</div>
              </div>
            </div>

            <hr class="my-4" />

            <!-- Credenciales -->
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">
  {{ 'register.email' | t }}
</label>
                <input
                  type="email"
                  class="form-control"
                  name="email"
                  [(ngModel)]="email"
                  required
                  email
                  #emailNg="ngModel"
                  [class.is-invalid]="
                    emailNg.invalid && (emailNg.touched || f.submitted)
                  "
                />
                <div class="invalid-feedback">
                  <ng-container *ngIf="emailNg.errors?.['required']"
                    >Email obligatorio.</ng-container
                  >
                  <ng-container *ngIf="emailNg.errors?.['email']"
                    >Ingresá un email válido.</ng-container
                  >
                </div>
              </div>

              <div class="col-md-6">
                <label class="form-label">
  {{ 'register.password' | t }}
</label>
                <div class="input-group">
                  <input
                    [type]="'password'"
                    class="form-control"
                    name="password"
                    [(ngModel)]="password"
                    required
                    minlength="6"
                    #pwdNg="ngModel"
                    [class.is-invalid]="
                      pwdNg.invalid && (pwdNg.touched || f.submitted)
                    "
                  />
                  <span class="input-group-text">
                    <i class="bi bi-shield-lock"></i>
                  </span>
                  <div class="invalid-feedback">
                    <ng-container *ngIf="pwdNg.errors?.['required']"
                      >Contraseña obligatoria.</ng-container
                    >
                    <ng-container *ngIf="pwdNg.errors?.['minlength']"
                      >Mínimo 6 caracteres.</ng-container
                    >
                  </div>
                </div>
                <div class="form-text">Mínimo 6–8 caracteres recomendados.</div>
              </div>
            </div>

            <!-- Imágenes paciente -->
            <div class="mt-4" *ngIf="rol === 'paciente'">
              <label class="form-label fw-semibold"
                >Imágenes de perfil (obligatorio)</label
              >
              <div class="row g-3">
                <div class="col-md-6">
                  <input
                    type="file"
                    class="form-control"
                    #fileP1
                    (change)="onFileChange('p1', $event)"
                    accept="image/*"
                    [class.is-invalid]="f.submitted && !fileP1.value"
                  />
                  <div class="form-text">Frente</div>
                  <div class="invalid-feedback">Subí la imagen frontal.</div>
                </div>
                <div class="col-md-6">
                  <input
                    type="file"
                    class="form-control"
                    #fileP2
                    (change)="onFileChange('p2', $event)"
                    accept="image/*"
                    [class.is-invalid]="f.submitted && !fileP2.value"
                  />
                  <div class="form-text">Perfil / adicional</div>
                  <div class="invalid-feedback">Subí la imagen adicional.</div>
                </div>
              </div>
            </div>

            <div class="mt-4" *ngIf="rol === 'especialista'">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">Imagen de perfil</label>
                  <input
                    type="file"
                    class="form-control"
                    (change)="onFileChange('esp', $event)"
                    accept="image/*"
                  />
                </div>

                <div class="col-md-6">
                  <label class="form-label">Especialidades</label>

                  <div class="specialty-multiselect">
                    <button
                      type="button"
                      class="specialty-multiselect-toggle"
                      [class.open]="specialtyDropdownOpen"
                      (click)="toggleSpecialtyDropdown()"
                    >
                      <span
                        *ngIf="
                          selectedSpecialtiesLabels().length;
                          else specialtiesPlaceholder
                        "
                      >
                        {{ selectedSpecialtiesLabels().join(", ") }}
                      </span>

                      <ng-template #specialtiesPlaceholder>
                        <span class="specialty-multiselect-placeholder">
                          Seleccioná una o varias especialidades
                        </span>
                      </ng-template>

                      <i
                        class="bi bi-chevron-down ms-auto small text-muted"
                      ></i>
                    </button>

                    <div
                      class="specialty-multiselect-dropdown"
                      *ngIf="specialtyDropdownOpen"
                    >
                      <div
                        class="specialty-option"
                        *ngFor="let s of specialties()"
                      >
                        <label class="form-check-label">
                          <input
                            type="checkbox"
                            class="form-check-input me-2"
                            [checked]="isSpecialtySelected(s.id)"
                            (change)="
                              toggleSpecialty(s.id, $any($event.target).checked)
                            "
                          />
                          <span>{{ s.nombre }}</span>
                        </label>
                      </div>

                      <div class="specialty-multiselect-footer">
                        <div class="input-group input-group-sm">
                          <input
                            class="form-control"
                            placeholder="Agregar nueva especialidad"
                            [(ngModel)]="specialtyOtherInput"
                            name="espNueva"
                          />
                          <button
                            type="button"
                            class="btn btn-outline-secondary"
                            (click)="addSpecialty()"
                          >
                            <i class="bi bi-plus-lg me-1"></i>
                            Agregar
                          </button>
                        </div>
                        <div class="form-text mt-1">
                          Las especialidades nuevas se usan solo para este
                          registro.
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="form-text mt-1">
                    Podés seleccionar una o varias especialidades marcando las
                    casillas.
                  </div>
                </div>
              </div>
            </div>

            <hr class="my-4" />
            <div class="mb-3" *ngIf="captchaEnabled">
              <label class="form-label">Captcha</label>
              <app-recaptcha
                [siteKey]="siteKey"
                (resolved)="onCaptchaResolved($event)"
              ></app-recaptcha>
              <div class="form-text">Marcá la casilla "No soy un robot".</div>
            </div>

            <!-- Submit -->
            <div class="d-grid mt-4">
              <button
                type="button"
                class="btn btn-primary btn-lg"
                [appCaptcha]="captchaEnabled"
                [persist]="false"
                (captchaPassed)="submit()"
              >
                <span
                  class="spinner-border spinner-border-sm me-2"
                  *ngIf="loading"
                ></span>
                Crear cuenta
              </button>
            </div>

            <p class="text-muted small mt-3 mb-0">
              Al registrarte aceptás nuestros términos y el tratamiento de datos
              personales.
            </p>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
