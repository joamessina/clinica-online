<div class="container py-4">
  <div class="row justify-content-center">
    <div class="col-xl-8 col-lg-9">
      <div class="card shadow-sm">
        <div class="card-header bg-light d-flex align-items-center gap-2">
          <i class="bi bi-person-plus"></i>
          <h5 class="mb-0">
            {{ "register.title" | t }}
          </h5>
        </div>

        <div class="card-body">
          <!-- Selector visual de perfil (solo se ve al entrar) -->
          <div *ngIf="!rol" class="role-picker mb-3">
            <button
              type="button"
              class="role-btn"
              (click)="chooseRole('paciente')"
            >
              <img [src]="patientImgUrl" [attr.alt]="'register.patient' | t" />
              <span>{{ "register.patient" | t }}</span>
            </button>

            <button
              type="button"
              class="role-btn"
              (click)="chooseRole('especialista')"
            >
              <img
                [src]="specialistImgUrl"
                [attr.alt]="'register.specialist' | t"
              />
              <span>{{ "register.specialist" | t }}</span>
            </button>
          </div>

          <form *ngIf="rol" #f="ngForm" novalidate>
            <!-- Datos personales -->
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">
                  {{ "register.name" | t }}
                </label>
                <input
                  class="form-control"
                  name="nombre"
                  [(ngModel)]="nombre"
                  required
                  #nombreNg="ngModel"
                  [class.is-invalid]="
                    nombreNg.invalid && (nombreNg.touched || f.submitted)
                  "
                />
                <div class="invalid-feedback">
                  {{ "register.invalid.name.required" | t }}
                </div>
              </div>

              <div class="col-md-6">
                <label class="form-label">
                  {{ "register.lastname" | t }}
                </label>
                <input
                  class="form-control"
                  name="apellido"
                  [(ngModel)]="apellido"
                  required
                  #apellidoNg="ngModel"
                  [class.is-invalid]="
                    apellidoNg.invalid && (apellidoNg.touched || f.submitted)
                  "
                />
                <div class="invalid-feedback">
                  {{ "register.invalid.lastname.required" | t }}
                </div>
              </div>

              <div class="col-md-4">
                <label class="form-label">
                  {{ "register.age" | t }}
                </label>
                <input
                  type="number"
                  class="form-control"
                  name="edad"
                  [(ngModel)]="edad"
                  min="1"
                  required
                  #edadNg="ngModel"
                  [class.is-invalid]="
                    edadNg.invalid && (edadNg.touched || f.submitted)
                  "
                />
                <div class="invalid-feedback">
                  <ng-container *ngIf="edadNg.errors?.['required']">
                    {{ "register.invalid.age.required" | t }}
                  </ng-container>
                  <ng-container *ngIf="edadNg.errors?.['min']">
                    {{ "register.invalid.age.min" | t }}
                  </ng-container>
                </div>
              </div>

              <div class="col-md-4">
                <label class="form-label">
                  {{ "register.dni" | t }}
                </label>
                <input
                  class="form-control"
                  name="dni"
                  [(ngModel)]="dni"
                  required
                  #dniNg="ngModel"
                  [class.is-invalid]="
                    dniNg.invalid && (dniNg.touched || f.submitted)
                  "
                />
                <div class="invalid-feedback">
                  {{ "register.invalid.dni.required" | t }}
                </div>
              </div>

              <div class="col-md-4" *ngIf="rol === 'paciente'">
                <label class="form-label" *ngIf="rol === 'paciente'">
                  {{ "register.healthInsurance" | t }}
                </label>
                <input
                  class="form-control"
                  name="obra"
                  [(ngModel)]="obra_social"
                  required
                  #obraNg="ngModel"
                  [class.is-invalid]="
                    obraNg.invalid && (obraNg.touched || f.submitted)
                  "
                />
                <div class="invalid-feedback">
                  {{ "register.invalid.health.required" | t }}
                </div>
              </div>
            </div>

            <hr class="my-4" />

            <!-- Credenciales -->
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">
                  {{ "register.email" | t }}
                </label>
                <input
                  type="email"
                  class="form-control"
                  name="email"
                  [(ngModel)]="email"
                  required
                  email
                  #emailNg="ngModel"
                  [class.is-invalid]="
                    emailNg.invalid && (emailNg.touched || f.submitted)
                  "
                />
                <div class="invalid-feedback">
                  <ng-container *ngIf="emailNg.errors?.['required']">
                    {{ "register.invalid.email.required" | t }}
                  </ng-container>
                  <ng-container *ngIf="emailNg.errors?.['email']">
                    {{ "register.invalid.email.format" | t }}
                  </ng-container>
                </div>
              </div>

              <div class="col-md-6">
                <label class="form-label">
                  {{ "register.password" | t }}
                </label>
                <div class="input-group">
                  <input
                    [type]="'password'"
                    class="form-control"
                    name="password"
                    [(ngModel)]="password"
                    required
                    minlength="6"
                    #pwdNg="ngModel"
                    [class.is-invalid]="
                      pwdNg.invalid && (pwdNg.touched || f.submitted)
                    "
                  />
                  <span class="input-group-text">
                    <i class="bi bi-shield-lock"></i>
                  </span>
                  <div class="invalid-feedback">
                    <ng-container *ngIf="pwdNg.errors?.['required']">
                      {{ "register.invalid.password.required" | t }}
                    </ng-container>
                    <ng-container *ngIf="pwdNg.errors?.['minlength']">
                      {{ "register.invalid.password.min" | t }}
                    </ng-container>
                  </div>
                </div>
                <div class="form-text">
                  {{ "register.helper.password" | t }}
                </div>
              </div>
            </div>

            <!-- ImÃ¡genes paciente -->
            <div class="mt-4" *ngIf="rol === 'paciente'">
              <label class="form-label fw-semibold">
                {{ "register.images.patient.title" | t }}
              </label>
              <div class="row g-3">
                <div class="col-md-6">
                  <input
                    type="file"
                    class="form-control"
                    #fileP1
                    (change)="onFileChange('p1', $event)"
                    accept="image/*"
                    [class.is-invalid]="f.submitted && !fileP1.value"
                  />
                  <div class="form-text">
                    {{ "register.images.patient.front" | t }}
                  </div>
                  <div class="invalid-feedback">
                    {{ "register.images.patient.frontError" | t }}
                  </div>
                </div>
                <div class="col-md-6">
                  <input
                    type="file"
                    class="form-control"
                    #fileP2
                    (change)="onFileChange('p2', $event)"
                    accept="image/*"
                    [class.is-invalid]="f.submitted && !fileP2.value"
                  />
                  <div class="form-text">
                    {{ "register.images.patient.side" | t }}
                  </div>
                  <div class="invalid-feedback">
                    {{ "register.images.patient.sideError" | t }}
                  </div>
                </div>
              </div>
            </div>

            <div class="mt-4" *ngIf="rol === 'especialista'">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">
                    {{ "register.images.specialist.title" | t }}
                  </label>
                  <input
                    type="file"
                    class="form-control"
                    (change)="onFileChange('esp', $event)"
                    accept="image/*"
                  />
                </div>

                <div class="col-md-6">
                  <label class="form-label">
                    {{ "register.specialties.label" | t }}
                  </label>

                  <div class="specialty-multiselect">
                    <button
                      type="button"
                      class="specialty-multiselect-toggle"
                      [class.open]="specialtyDropdownOpen"
                      (click)="toggleSpecialtyDropdown()"
                    >
                      <span
                        *ngIf="
                          selectedSpecialtiesLabels().length;
                          else specialtiesPlaceholder
                        "
                      >
                        {{ selectedSpecialtiesLabels().join(", ") }}
                      </span>

                      <ng-template #specialtiesPlaceholder>
                        <span class="specialty-multiselect-placeholder">
                          {{ "register.specialties.placeholder" | t }}
                        </span>
                      </ng-template>

                      <i
                        class="bi bi-chevron-down ms-auto small text-muted"
                      ></i>
                    </button>

                    <div
                      class="specialty-multiselect-dropdown"
                      *ngIf="specialtyDropdownOpen"
                    >
                      <div
                        class="specialty-option"
                        *ngFor="let s of specialties()"
                      >
                        <label class="form-check-label">
                          <input
                            type="checkbox"
                            class="form-check-input me-2"
                            [checked]="isSpecialtySelected(s.id)"
                            (change)="
                              toggleSpecialty(s.id, $any($event.target).checked)
                            "
                          />
                          <span>{{ s.nombre }}</span>
                        </label>
                      </div>

                      <div class="specialty-multiselect-footer">
                        <div class="input-group input-group-sm">
                          <input
                            class="form-control"
                            [placeholder]="
                              'register.specialties.addPlaceholder' | t
                            "
                            [(ngModel)]="specialtyOtherInput"
                            name="espNueva"
                          />
                          <button
                            type="button"
                            class="btn btn-outline-secondary"
                            (click)="addSpecialty()"
                          >
                            <i class="bi bi-plus-lg me-1"></i>
                            {{ "register.specialties.addButton" | t }}
                          </button>
                        </div>
                        <div class="form-text mt-1">
                          {{ "register.specialties.helperOnce" | t }}
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="form-text mt-1">
                    {{ "register.specialties.helperMulti" | t }}
                  </div>
                </div>
              </div>
            </div>

            <hr class="my-4" />

            <div class="mb-3" *ngIf="captchaEnabled">
              <label class="form-label">
                {{ "register.captcha.label" | t }}
              </label>
              <app-recaptcha
                [siteKey]="siteKey"
                (resolved)="onCaptchaResolved($event)"
              ></app-recaptcha>
              <div class="form-text">
                {{ "register.captcha.helper" | t }}
              </div>
            </div>

            <!-- Submit -->
            <div class="d-grid mt-4">
              <button
                type="button"
                class="btn btn-primary btn-lg"
                [appCaptcha]="captchaEnabled"
                [persist]="false"
                (captchaPassed)="submit()"
              >
                <span
                  class="spinner-border spinner-border-sm me-2"
                  *ngIf="loading"
                ></span>
                {{ "register.submit" | t }}
              </button>
            </div>

            <p class="text-muted small mt-3 mb-0">
              {{ "register.footer" | t }}
            </p>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
