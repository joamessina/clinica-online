<div class="turnos-header mb-3">
  <div class="d-flex align-items-center gap-2">
    <app-back-button
      variant="secondary"
      size="sm"
      label="Volver"
    ></app-back-button>

    <div class="header-text">
      <h2 class="mb-0">Mis turnos</h2>
      <p class="mb-0 small">
        Administrá los turnos del día, cambiá su estado y completá la atención
        de cada paciente.
      </p>
    </div>
  </div>
</div>

<!-- BUSCADOR CON ICONO -->
<div class="search-wrapper mb-3">
  <i class="bi bi-search"></i>
  <input
    class="form-control search-input"
    [ngModel]="q()"
    (ngModelChange)="q.set($event)"
    placeholder="Filtrar por especialidad, paciente, estado o reseña..."
  />
</div>

<!-- TABLA -->
<div class="table-responsive">
  <table class="table align-middle">
    <thead>
      <tr>
        <th>Fecha</th>
        <th>Hora</th>
        <th>Especialidad</th>
        <th>Paciente</th>
        <th>Estado</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let t of filtered()">
        <td>{{ t.fecha | date : "d/MM" }}</td>
        <td>{{ t.hora?.slice(0, 5) }}</td>
        <td>{{ t.especialidad_nombre }}</td>
        <td>{{ t.paciente_nombre }}</td>
        <td>
          <span class="badge" [attr.data-status]="t.estado">
            {{ t.estado }}
          </span>
        </td>

        <td>
          <div class="actions">
            <button
              class="btn btn-sm btn-primary"
              *ngIf="canAccept(t)"
              (click)="aceptar(t)"
            >
              Aceptar
            </button>

            <button
              class="btn btn-sm btn-outline-danger"
              *ngIf="canReject(t)"
              (click)="rechazar(t)"
            >
              Rechazar
            </button>

            <button
              class="btn btn-sm btn-outline-secondary"
              *ngIf="canCancel(t)"
              (click)="cancelar(t)"
            >
              Cancelar
            </button>

            <button
              class="btn btn-sm btn-success"
              *ngIf="canFinish(t)"
              (click)="openHistoryModal(t)"
            >
              Finalizar / Historia
            </button>

            <button
              class="btn btn-sm btn-outline-dark"
              *ngIf="hasResena(t)"
              (click)="verResena(t)"
            >
              Ver reseña
            </button>
          </div>
        </td>
      </tr>
    </tbody>
  </table>
</div>

<!-- MODAL HISTORIA CLÍNICA -->
<div
  *ngIf="showHistoryModal"
  class="modal-backdrop-custom"
  style="
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1050;
  "
>
  <div
    class="card"
    style="max-width: 600px; width: 100%; max-height: 90vh; overflow: auto"
  >
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0">Historia clínica</h5>
      <button
        type="button"
        class="btn btn-sm btn-outline-secondary"
        (click)="showHistoryModal = false"
      >
        Cerrar
      </button>
    </div>

    <div class="card-body">
      <div class="row g-3">
        <div class="col-6">
          <label class="form-label">Altura (cm)</label>
          <input
            type="number"
            class="form-control"
            [(ngModel)]="historyForm.altura"
          />
        </div>
        <div class="col-6">
          <label class="form-label">Peso (kg)</label>
          <input
            type="number"
            class="form-control"
            [(ngModel)]="historyForm.peso"
          />
        </div>
        <div class="col-6">
          <label class="form-label">Temperatura (°C)</label>
          <input
            type="number"
            step="0.1"
            class="form-control"
            [(ngModel)]="historyForm.temperatura"
          />
        </div>
        <div class="col-6">
          <label class="form-label">Presión</label>
          <input
            class="form-control"
            placeholder="120/80"
            [(ngModel)]="historyForm.presion"
          />
        </div>

        <div class="col-12 mt-2">
          <label class="form-label fw-semibold">Datos adicionales</label>
        </div>

        <div class="col-12" *ngFor="let e of historyForm.extras; index as i">
          <div class="row g-2">
            <div class="col-5">
              <input
                class="form-control"
                placeholder="clave (ej: caries)"
                [(ngModel)]="e.key"
                name="extra_key_{{ i }}"
              />
            </div>
            <div class="col-7">
              <input
                class="form-control"
                placeholder="valor (ej: 4)"
                [(ngModel)]="e.value"
                name="extra_value_{{ i }}"
              />
            </div>
          </div>
        </div>
        <!-- 1) CONTROL DE RANGO 0–100 -->
        <div class="col-12">
          <label class="form-label"
            >Índice de severidad clínica (0 a 100)</label
          >
          <p class="form-text small mb-1">
            0 = asintomático · 100 = máxima severidad reportada.
          </p>
          <div class="d-flex align-items-center gap-3">
            <input
              type="range"
              min="0"
              max="100"
              class="form-range flex-grow-1"
              [(ngModel)]="historyForm.extraRango"
              name="extra_rango"
            />
            <span class="badge bg-primary-subtle text-primary">
              {{ historyForm.extraRango ?? 0 }}
            </span>
          </div>
        </div>

        <!-- 2) CUADRO DE TEXTO NUMÉRICO -->
        <div class="col-12">
          <label class="form-label">Oxigeno en Sangre</label>
          <input
            type="number"
            class="form-control"
            [(ngModel)]="historyForm.extraNumero"
            name="extra_numero"
          />
        </div>

        <!-- 3) SWITCH “SI / NO” -->
        <div class="col-12">
          <label class="form-label d-block">¿Requiere seguimiento?</label>
          <div class="form-check form-switch">
            <input
              class="form-check-input"
              type="checkbox"
              role="switch"
              id="extraSwitch"
              [(ngModel)]="historyForm.extraSwitch"
              name="extra_switch"
            />
            <label class="form-check-label" for="extraSwitch">
              {{ historyForm.extraSwitch ? "Sí" : "No" }}
            </label>
          </div>
        </div>

        <div class="col-12 mt-3">
          <label class="form-label">Reseña / Notas</label>
          <textarea
            rows="3"
            class="form-control"
            [(ngModel)]="historyResena"
          ></textarea>
        </div>
      </div>
    </div>

    <div class="card-footer d-flex justify-content-end gap-2">
      <button
        type="button"
        class="btn btn-outline-secondary"
        (click)="showHistoryModal = false"
      >
        Cancelar
      </button>
      <button
        type="button"
        class="btn btn-primary"
        (click)="saveHistoryAndFinish()"
      >
        Guardar y finalizar turno
      </button>
    </div>
  </div>
</div>
